{{#extends "base"}}

    {{#block "content"}}
        <a href="/admin" class="btn btn-lg btn-secondary">Back</a>
        <div class="mt-3 border border-info p-3">
            <form method="POST">
                <h1>Add a Vault</h1>
                <input type="hidden" name="_csrf" value="{{csrfToken}}" />
                {{{form}}}
                <div>
                    <a href="#" class="btn btn-primary mt-2" id="upload_widget">Upload Image</a>
                    <img src="" style="display:none" id="uploaded_image" />
                </div>
                <input type="submit" value="Add Vault" class="btn btn-primary mt-2" />
            </form>
        </div>
        <h1 class="mt-3">Vaults</h1>

        <table class="table">
            <thead>
                <tr>
                    <th>Name</th>
                    <th>Address</th>
                    <th>Postal</th>
                    <th>Country</th>
                    <th>Update</th>
                    <th>Delete</th>
                </tr>

            </thead>
            <tbody>
                {{#each vaults}}
                    <tr>
                        <td>
                            {{this.name}}
                        </td>
                        <td>
                            {{this.address}}
                        </td>
                        <td>
                            {{this.postal}}
                        </td>
                        <td>
                            {{this.country.name}}
                        </td>
                        <td>
                            <a href="/vaults/{{this.id}}/update" class="btn btn-success">Update</a>
                        </td>
                        <td>
                            <a href="/vaults/{{this.id}}/delete" class="btn btn-danger">Delete</a>
                        </td>
                    </tr>
                {{/each}}
            </tbody>
        </table>
    {{/block}}

{{/extends}}

{{#block 'js'}}
<script src="https://cdnjs.cloudflare.com/ajax/libs/axios/0.21.1/axios.min.js" integrity="sha512-bZS47S7sPOxkjU/4Bt0zrhEtWx0y0CRkhEp8IckzK+ltifIIE9EMIMTuT/mEzoIMewUINruDBIR/jJnbguonqQ==" crossorigin="anonymous"></script>

<script src="https://widget.cloudinary.com/v2.0/global/all.js" type="text/javascript"></script>

<script>
function generateSignature(callback,params_to_sign){
  axios.get('/cloudinary/sign',{
    params:{
      params_to_sign
    }
  }).then(function(response){
    callback(response.data);
  })
}


// create the upload widget 
var myWidget = cloudinary.createUploadWidget({
    cloudName: '{{cloudinaryName}}',
    apiKey: '{{cloudinaryApiKey}}',
    uploadPreset: '{{cloudinaryPreset}}',
    uploadSignature: generateSignature
  }, (error, result) => {
    if (!error && result && result.event === "success") {
      console.log('Done! Here is the image info: ', result.info);
      // hide the upload widget 
      document.querySelector('#upload_widget').style.display="none";

      // display the image
      document.querySelector('#id_image_url').value = result.info.url;
      document.querySelector('#uploaded_image').src = result.info.url;
      document.querySelector('#uploaded_image').style.display = 'inline';
    }
  }
)

document.getElementById("upload_widget").addEventListener("click", function(){
    myWidget.open();
  }, false);
</script>

{{/block}}
